<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>민지 메인페이지</title>
    <style>
        .header {
            text-align: center;
        }

        .write-wrap {
            display: flex;
        }

        .write-wrap .write-profile {
            width: 10%;
            background: plum;
        }

        .write-wrap .write-box {
            width: 90%;
            background: antiquewhite;
        }

        .myprofile {
            border-radius: 50%;
            background: #A77AFE;
            width: 50px;
            height: 50px;
            font-size: 1px;

            text-align: center;
        }

        .posts-feed {
            margin-top: 3rem;
            display: grid;
            justify-content: center;
            align-items: center;

        }

        .card {
            display: flex;
            flex-direction: row;
        }

        .card-title {
            cursor: pointer;
        }

        .card-footer {
            display: flex;
        }

    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
</head>
<body>
<div>
    <div class="header">
        <h1>LogTown</h1>
    </div>

    <div class="write-wrap">
        <!--        하위 두 div는 나란히 정렬-->
        <div class="write-profile">
            <div class="myprofile">내 프로필</div>

        </div>
        <div class="write-box">
            <div class="content-box">
                <textarea id="postContent" placeholder="내용 입력"></textarea>
            </div>
            <div class="under">
                <button id="submitPost">작성하기</button>
            </div>
        </div>
    </div>

    <div class="posts-feed">
        <div class="one-post" id="getOnePost">
            <div class="card mb-3" style="max-width: 50rem;">
                <div class="row g-0" id="goclick">
                    <div class="col-md-1">
                        <div class="myprofile">프로필</div>
                    </div>
                    <div class="col-md-10">
                        <div class="card-body">
                            <h5 class="card-title">Card title</h5>
                            <p class="card-text">This is a wider card with supporting text below as a natural lead-in to
                                additional content. This content is a little bit longer.</p>
                            <p class="card-text"><small class="text-muted">Last updated 3 mins ago</small></p>
                            <button id="gotopost">보기</button>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <p style="color:red">❤</p>
                    <p class="card-text">127</p>
                    <button id="postLike">좋아요</button>
                    <button id="deleteLike">좋아요 취소</button>
                </div>
            </div>
        </div>
        <div id="listEnd"></div>
    </div>

</div>

<script>
    $(document).ready(function () {

        let authCookie = Cookies.get("Authorization");  // cookie 중 Authorization
        let page = 0;

        // 프로필 동그라미 클릭 시
        $('.posts-feed').on('click', '.myprofile', function () {
            // post.userId와 post.nickname 가져오기
            const userId = $(this).attr('id');
            const nickname = $(this).text();

            console.log('Clicked user ID:', userId);
            console.log('Clicked nickname:', nickname);

            window.location.href = `${window.location.origin}/home/detailpage/${userId}`;
        });


        // 게시글 좋아요 버튼 클릭 시
        $(document).on("click", ".card-footer #postLike", function(event) {
            event.preventDefault();
            let postId = $(this).closest('.card').attr('id');

            console.log(postId);

            $.ajax({
                url: `/api/posts/${postId}/like`,
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'Authorization': authCookie // 클라이언트 쿠키의 값을 전달
                },
                success: function (xhr) {
                    alert('좋아요 성공');
                    location.reload();
                },
                error: function (xhr) {
                    alert(xhr.responseJSON.errorMessage);
                    location.reload();
                }
            });
        });

        // 게시글 좋아요 취소 버튼 클릭 시
        $(document).on("click", ".card-footer #deleteLike", function(event) {
            event.preventDefault();
            let postId = $(this).closest('.card').attr('id');

            console.log(postId);

            $.ajax({
                url: `/api/posts/${postId}/like`,
                type: 'DELETE',
                contentType: 'application/json',
                headers: {
                    'Authorization': authCookie // 클라이언트 쿠키의 값을 전달
                },
                success: function (xhr) {
                    alert('좋아요 취소 성공');
                    location.reload();
                },
                error: function (xhr) {
                    alert(xhr.responseJSON.errorMessage);
                    location.reload();
                }
            });
        });

        //게시글 하나 선택
        $(document).on("click","#gotopost", function(event) {
            event.preventDefault();

            let postId = $(this).closest('.card').attr('id');

            console.log(postId);

            $.ajax({
                url: `/api/posts/${postId}`,
                type: 'GET',
                contentType: 'application/json',
                headers: {
                    'Authorization': authCookie // 클라이언트 쿠키의 값을 전달
                },
                success: function (xhr) {
                    console.log('이동');
                    //console.log(response.id);

                    window.location.href = `${window.location.origin}/home/onepost/${postId}`;
                },
                error: function () {
                    console.log('게시글 등록 error 실패');
                }
            });
        })

        // 게시글 가져오는 부분
        $.ajax({
            url: '/api/posts/followingposts?page=0',
            type: 'GET',
            contentType: 'application/json',
            headers: {
                'Authorization': authCookie  // 확실x, 이전 프로젝트에서 cookie로 로그인해서 .cookie였음
            },
            success: function (xhr) {
                console.log('followingposts GET 요청 성공');
                console.log(xhr);
                $('.posts-feed').empty();

                let temp_html = ``;

                xhr.content.forEach(function (post) {

                    let card_html = `
                                    <div class="one-post" id="getOnePost">
                                        <div class="card mb-3" style="width: 50rem;" id="${post.id}">
                                            <div class="row g-0" id="goclick">
                                                <div class="col-md-1">
                                                    <div class="myprofile" id="${post.userId}">${post.nickname}</div>
                                                </div>
                                                <div class="col-md-8">
                                                    <div class="card-body">
                                                        <h5 class="card-title" id="post-nickname-btn">${post.nickname}</h5>
                                                        <p class="card-text">${post.content}</p>
                                                        <p class="card-text"><small class="text-muted">${post.modifiedAt}</small></p>
                                                        <button id="gotopost">보기</button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-footer">
                                                <p style="color:red">❤</p>
                                                <p class="card-text">${post.likeCnt}</p>
                                                <button id="postLike">좋아요</button>
                                                <button id="deleteLike">좋아요 취소</button>
                                            </div>
                                        </div>
                                    </div>
                    `
                    temp_html += card_html;
                })

                $('.posts-feed').append(temp_html);
            },
            error: function () {
                console.log('게시글 불러오기 실패');
            }

        });

        // 스크롤 끝나면 다음 slice 가져오기
        $(function () {
            //let page = 0;
            $(window).scroll(function () {
                if ($(window).scrollTop() + $(window).height() >= $(document).height()) {
                    if (page === -1) {
                        alert('페이지 끝');
                    }

                    // 다음 page 요청
                    page++;
                    $.ajax({
                        url: '/api/posts/followingposts?page=' + page,
                        type: 'GET',
                        contentType: 'application/json',
                        headers: {
                            'Authorization': authCookie  // 확실x, 이전 프로젝트에서 cookie로 로그인해서 .cookie였음
                        },
                        success: function (xhr) {
                            console.log('스크롤 끝 GET 요청 성공');
                            console.log(xhr);

                            // 이번이 마지막 slice라면
                            if (xhr.content.last === true) {
                                page = -1;
                            }

                            let temp_html = ``;

                            //console.log(xhr.content[0]);
                            xhr.content.forEach(function (post) {
                                console.log(post);

                                let card_html = `
                                    <div class="one-post" id="getOnePost">
                                        <div class="card mb-3" style="width: 50rem;" id="${post.id}">
                                            <div class="row g-0" id="goclick">
                                                <div class="col-md-1">
                                                    <div class="myprofile" id="${post.userId}">${post.nickname}</div>
                                                </div>
                                                <div class="col-md-8">
                                                    <div class="card-body">
                                                        <h5 class="card-title"  id="post-nickname-btn">${post.nickname}</h5>
                                                        <p class="card-text">${post.content}</p>
                                                        <p class="card-text"><small class="text-muted">${post.modifiedAt}</small></p>
                                                        <button id="gotopost">보기</button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-footer">
                                                <p style="color:red">❤</p>
                                                <p class="card-text">${post.likeCnt}</p>
                                                <button id="postLike">좋아요</button>
                                                <button id="deleteLike">좋아요 취소</button>
                                            </div>
                                        </div>
                                    </div>
                    `
                                temp_html += card_html;
                            })
                            temp_html += `
                              <div id = "listEnd"></div>  `
                            $('.posts-feed').append(temp_html);
                        },
                        error: function () {
                            console.log('게시글 불러오기 실패');
                        }

                    });
                }
            });
        });

        // 게시글 작성
        $('#submitPost').click(function (event) {
            event.preventDefault();
            let postContent = $('#postContent').val();
            let data = {
                content: postContent
            };

            console.log(postContent);

            if (postContent.trim() === '') {
                alert('내용을 입력하세요');
                return;
            }

            $.ajax({
                url: '/api/posts',
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'Authorization': authCookie // 클라이언트 쿠키의 값을 전달
                },
                data: JSON.stringify(data),
                success: function (xhr) {
                    console.log(xhr);
                    //console.log(response.id);
                    alert("게시글 등록 성공");
                    location.reload();
                    //window.location.href = `${window.location.origin}/home/mainpage`;
                },
                error: function () {
                    console.log('게시글 등록 error 실패');
                }
            });
        });

    });
</script>
</body>
</html>